---
title: setTimeout、Promise、Async/Await 的区别
tags: JS
date: 2019-02-28 22:52:37
categories: 每日一题
---

### 相关参考：

- [async await、Promise、setTimeout执行顺序](https://juejin.im/post/5b191d585188257d831e338e)
- [async](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Statements/async_function)
- [await](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Operators/await)
- [JavaScript 是如何工作的: 事件循环和异步编程的崛起 + 5个如何更好的使用 async/await 编码的技巧](https://github.com/xitu/gold-miner/blob/master/TODO/how-javascript-works-event-loop-and-the-rise-of-async-programming-5-ways-to-better-coding-with.md)

### 相关问题参考

#### 执行先后顺序 setTimeout、Promise、Async/Await 对比

下面函数的执行顺序为？
```javascript
async function async1() {
    console.log('async1 start');
    await async2();
    console.log('async1 end');
}
async function async2() {
    console.log('async2');
}

console.log('start');
setTimeout(() => {
    console.log('setTimeout');
}, 0);
async1();
new Promise(resolve => {
    console.log('promise1');
    resolve();
}).then(() => {
    console.log('promise2');
})
console.log('end');
```

node v10.13.0运行结果
```
start
async1 start
async2
promise1
end
promise2
async1 end
setTimeout
```

### 调用顺序问题解析：

**async**

> async function name([param[, param[, ... param]]]) { statements }

`async` 会定义一个返回 AsyncFunction 对象的异步函数。即以 `async` 声明的函数，会隐式地返回一个 `Promise` 对象。当这个 `async` 函数返回一个值时，`Promise` 的 `resolve` 方法会负责传递这个值；当 `async` 函数抛出异常时，`Promise` 的 `reject` 方法也会传递这个异常值。

**await**

> [return_value] = await expression;

`await` 操作符用于等待一个 `Promise` 对象。它返回 `Promise` 对象的处理结果。如果等待的不是 `Promise` 对象，则返回该值本身。

> 注意：
> `await` 只能在异步函数 `async function` 中使用。
> 如果你希望并行等待两个或者是更多的 `Promise` 对象，你必须使用`Promise.then`，而不是`await`。

**队列任务优先级：**`promise.Trick()` > `promise的回调` > `setTimeout` > `setImmediate`

因此上述代码可以理解成：（部分用语可能不准确）

在同步执行阶段：
`async1`执行到`await async2()`时，`sync2()`返回一个`Promise`, 其`resolve`放入到回调队列中，跳出`async1`，执行`new promise`的`resolve`时，该`resolve`也会被放入回调队列中。然后执行到`console.log('end');`，此时同步执行结束。

**重点（执行回调队列）**：
此时`async2()`返回的 Promise的`resolve`会被执行，即执行`await async2()`，此时`await`的`Promise`的`resolve`会被放入到新回调队列。此时原回调队列中`new promise`的`resolve`会被执行，`promise2`字符被打印，原回调队列执行完毕。

执行新回调队列：
`await`的`Promise`的`resolve`被执行，`console.log('async1 end')`执行。`async1()`返回的`Promise`的`resolve`会被放入到新回调队列。

所有回调队列执行完毕，`setTimeout`执行。

